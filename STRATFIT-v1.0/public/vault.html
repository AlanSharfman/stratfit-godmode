<!DOCTYPE html>
<html>
<head>
  <title>STRATFIT | Decision Vault</title>
  <link rel="stylesheet" href="../assets/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="simulate">
  <header class="context-bar">
    <div style="font-weight:700;">Decision Vault</div>
    <div style="color:#9BA1AA;font-size:12px;">All past strategy decisions</div>
  </header>

  <section class="summary-box" style="margin: 20px 24px 0 24px;">
    <label>Filter by Strategy:
      <select id="filter-strategy">
        <option value="">All</option>
        <option value="ACCUMULATE">ACCUMULATE</option>
        <option value="DEFENSIVE">DEFENSIVE</option>
        <option value="NEUTRAL">NEUTRAL</option>
      </select>
    </label>
    <button id="export-csv" class="btn" style="margin-left: 10px;">Export CSV</button>
  </section>

  <section class="summary-box" style="margin: 20px 24px 24px 24px;">
    <table id="vault-table">
      <thead>
        <tr>
          <th>Run ID</th>
          <th>Strategy</th>
          <th>Alpha</th>
          <th>Confidence</th>
          <th>User</th>
          <th>Timestamp</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <nav class="nav-strip">
    <button class="nav-btn">TERRAIN</button>
    <button class="nav-btn">COMPARE</button>
    <button class="nav-btn">RISK</button>
    <button class="nav-btn">VALUATION</button>
    <button class="nav-btn">DECISION</button>
  </nav>

  <div style="padding: 12px 24px;">
    <a href="vault.html">Decision Vault â†’</a>
  </div>

  <script src="../src/js/auth.js"></script>
  <script src="../src/js/simulate.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const table = document.querySelector("#vault-table tbody");
      const filter = document.getElementById("filter-strategy");

      let history = [];

      try {
        const res = await fetch("/api/decision-history");
        history = await res.json();
      } catch (e) {
        console.warn("Fallback to localStorage");
        history = JSON.parse(localStorage.getItem("decisionAudit") || "[]");
      }

      function render(filtered) {
        table.innerHTML = "";
        filtered.forEach(entry => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${entry.runId}</td>
            <td>${entry.strategy}</td>
            <td>${entry.alpha}%</td>
            <td>${entry.confidence}%</td>
            <td>${entry.user || "n/a"}</td>
            <td>${new Date(entry.timestamp).toLocaleString()}</td>
            <td><a href="decision.html?run=${entry.runId}">View</a></td>
          `;
          table.appendChild(row);
        });
      }

      render(history);

      filter.addEventListener("change", () => {
        const val = filter.value;
        const filtered = val ? history.filter(e => e.strategy === val) : history;
        render(filtered);
      });

      document.getElementById("export-csv").addEventListener("click", () => {
        const rows = [
          ["Run ID", "Strategy", "Alpha", "Confidence", "User", "Timestamp"],
          ...history.map(e => [
            e.runId, e.strategy, e.alpha, e.confidence,
            e.user || "n/a", new Date(e.timestamp).toISOString()
          ])
        ];

        const csv = rows.map(r => r.join(",")).join("\\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `stratfit-decisions.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });
    });
  </script>
</body>
</html>


